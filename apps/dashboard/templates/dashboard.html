{% extends 'dashboard_base.html' %}
{% load static %}
{% block title %} SISIMPUR - AI-Powered Exam Prep {% endblock %}

{% block content %}


    <!-- Page Content -->
    <div class="content-wrapper">
      <div class="content-container">
        <div class="quiz-section">
          <h1 class="page-title">Create Quiz</h1>
          <p class="page-description">Generate AI-powered quizzes from your content</p>

          <div class="quiz-form">
            <!-- Quiz Options Form -->
            <div class="quiz-options-form">
              <h3>Quiz Configuration</h3>

              <div class="quiz-options">
                <div class="option-group">
                  <label for="question-count">Number of Questions</label>
                  <select class="quiz-select" id="question-count" name="num_questions">
                    <option value="">Auto (Optimal)</option>
                    <option value="3">3 Questions</option>
                    <option value="5">5 Questions</option>
                    <option value="8">8 Questions</option>
                    <option value="10" selected>10 Questions</option>
                    <option value="15">15 Questions</option>
                    <option value="20">20 Questions</option>
                  </select>
                </div>

                <div class="option-group">
                  <label for="question-type">Question Type</label>
                  <select class="quiz-select" id="question-type" name="question_type">
                    <option value="MULTIPLECHOICE" selected>Multiple Choice</option>
                    <option value="SHORT">Short Answer</option>
                  </select>
                </div>

                <div class="option-group">
                  <label for="language">Language Detection</label>
                  <select class="quiz-select" id="language" name="language">
                    <option value="auto" selected>Auto Detect</option>
                    <option value="english">English</option>
                    <option value="bengali">Bengali</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Dropzone File Upload -->
            <div class="upload-section">
              <h3>Upload Document</h3>
              <p class="upload-description">Upload a document first, then click Generate to process it</p>

              <!-- CSRF token for Dropzone AJAX -->
              <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

              <div class="dropzone" id="document-dropzone">
                <div class="dz-message" data-dz-message>
                  <div class="upload-icon">
                    <i class="ri-upload-cloud-line"></i>
                  </div>
                  <h4>Drop files here or click to upload</h4>
                  <p>Supported: PDF, JPG, PNG (Max 10MB)</p>
                </div>
              </div>

              <!-- Generate Button -->
              <button type="button" class="generate-btn" id="generate-btn" disabled>
                <i class="ri-magic-line"></i>
                <span id="btn-text">Generate Quiz</span>
                <div id="loading-spinner" style="display: none;">
                  <i class="ri-loader-4-line"></i> Processing...
                </div>
              </button>
            </div>

            <!-- Modern Processing Status -->
            <div id="processing-status" style="display: none;" class="modern-processing-status">
              <div class="processing-container">
                <!-- Animated Background -->
                <div class="processing-bg">
                  <div class="processing-particles"></div>
                  <div class="processing-waves">
                    <div class="wave wave-1"></div>
                    <div class="wave wave-2"></div>
                    <div class="wave wave-3"></div>
                  </div>
                </div>

                <!-- Main Content -->
                <div class="processing-content">
                  <!-- Progress Ring -->
                  <div class="progress-ring-container">
                    <svg class="progress-ring" width="120" height="120">
                      <defs>
                        <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                          <stop offset="0%" style="stop-color:#5e17eb;stop-opacity:1" />
                          <stop offset="100%" style="stop-color:#00d4ff;stop-opacity:1" />
                        </linearGradient>
                      </defs>
                      <circle class="progress-ring-bg" cx="60" cy="60" r="50" />
                      <circle class="progress-ring-fill" cx="60" cy="60" r="50" id="progress-circle" />
                    </svg>
                    <div class="progress-center">
                      <div class="progress-icon" id="progress-icon">
                        <i class="ri-file-text-line"></i>
                      </div>
                      <div class="progress-percentage" id="progress-percentage">0%</div>
                    </div>
                  </div>

                  <!-- Status Info -->
                  <div class="status-info">
                    <h3 id="status-title">Processing Document</h3>
                    <p id="status-message">Preparing your document for analysis...</p>
                    <div class="status-stages">
                      <div class="stage" id="stage-upload">
                        <div class="stage-icon"><i class="ri-upload-line"></i></div>
                        <span>Upload</span>
                      </div>
                      <div class="stage" id="stage-analyze">
                        <div class="stage-icon"><i class="ri-search-line"></i></div>
                        <span>Analyze</span>
                      </div>
                      <div class="stage" id="stage-generate">
                        <div class="stage-icon"><i class="ri-magic-line"></i></div>
                        <span>Generate</span>
                      </div>
                      <div class="stage" id="stage-complete">
                        <div class="stage-icon"><i class="ri-check-line"></i></div>
                        <span>Complete</span>
                      </div>
                    </div>
                  </div>

                  <!-- Estimated Time -->
                  <div class="estimated-time">
                    <i class="ri-time-line"></i>
                    <span id="estimated-time">Estimating time...</span>
                  </div>

                  <!-- Cancel Button -->
                  <button class="cancel-processing-btn" id="cancel-processing" onclick="cancelProcessing()">
                    <i class="ri-close-line"></i>
                    Cancel Processing
                  </button>
                </div>
              </div>
            </div>

            <!-- Recent Jobs -->
            {% if recent_jobs %}
            <div class="recent-jobs">
              <h3>Recent Quizzes</h3>
              <div class="jobs-list">
                {% for job in recent_jobs %}
                <div class="job-item">
                  <div class="job-info" style="flex: 1 1 0; min-width: 0;">
                    <h4 class="job-filename" title="{{ job.document_name }}">{{ job.document_name }}</h4>
                    <p class="job-status status-{{ job.status }}">{{ job.get_status_display }}</p>
                    <small>{{ job.created_at|date:"M d, Y H:i" }}</small>
                  </div>
                  <div class="job-actions">
                    {% if job.status == 'completed' %}
                      <a href="{% url 'dashboard:start_exam' job.id %}" class="btn-small btn-primary">
                        <i class="ri-play-circle-line"></i>
                        Start Exam
                      </a>
                      <a href="{% url 'dashboard:start_flashcard' job.id %}" class="btn-small btn-secondary">
                        <i class="ri-stack-line"></i>
                        Start Flashcard
                      </a>
                      <button class="btn-small btn-danger" onclick="deleteQuiz({{ job.id }}, '{{ job.document_name|escapejs }}')">
                        <i class="ri-delete-bin-line"></i>
                      </button>
                    {% elif job.status == 'failed' %}
                      <span class="error-text">Failed</span>
                      <button class="btn-small btn-danger" onclick="deleteQuiz({{ job.id }}, '{{ job.document_name|escapejs }}')">
                        <i class="ri-delete-bin-line"></i>
                      </button>
                    {% else %}
                      <span class="processing-text">Processing...</span>
                    {% endif %}
                  </div>
                </div>
                {% endfor %}
              </div>
              <a href="{% url 'dashboard:my_quizzes' %}" class="view-all-link">View All Quizzes â†’</a>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    </main>

<!-- Dropzone JavaScript -->
<script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js"></script>

<script>
// Disable Dropzone auto discover
Dropzone.autoDiscover = false;

document.addEventListener('DOMContentLoaded', function() {
    const processingStatus = document.getElementById('processing-status');
    const statusMessage = document.getElementById('status-message');
    const generateBtn = document.getElementById('generate-btn');
    const btnText = document.getElementById('btn-text');
    const loadingSpinner = document.getElementById('loading-spinner');

    let uploadedFile = null;

    // Initialize progress ring
    const progressCircle = document.getElementById('progress-circle');
    if (progressCircle) {
        const circumference = 2 * Math.PI * 50;
        progressCircle.style.strokeDasharray = circumference;
        progressCircle.style.strokeDashoffset = circumference;
    }

    // Get quiz configuration values
    function getQuizConfig() {
        return {
            num_questions: document.getElementById('question-count').value,
            question_type: document.getElementById('question-type').value,
            language: document.getElementById('language').value
        };
    }

    // Custom Dropzone preview template (only remove button, modern look)
    const customPreviewTemplate = `
      <div class="dz-preview dz-file-preview modern-preview">
        <div class="dz-details">
          <div class="dz-filename"><span data-dz-name></span></div>
          <div class="dz-size" data-dz-size></div>
        </div>
        <div class="dz-remove-btn">
          <a class="dz-remove" href="javascript:undefined;" data-dz-remove>
            <i class="ri-close-line"></i> Remove file
          </a>
        </div>
      </div>
    `;

    // Initialize Dropzone (upload only, no auto-processing)
    const myDropzone = new Dropzone("#document-dropzone", {
        url: "#", // Dummy URL since we won't auto-upload
        autoProcessQueue: false,
        paramName: "document",
        maxFilesize: 10, // MB
        maxFiles: 1,
        acceptedFiles: ".jpg,.jpeg,.png,.pdf", // BETA: Intigrate PDF support
        dictDefaultMessage: "Drop files here or click to upload",
        dictFallbackMessage: "Your browser does not support drag'n'drop file uploads.",
        dictFileTooBig: "File is too big ({{filesize}}MiB). Max filesize: {{maxFilesize}}MiB.",
        dictInvalidFileType: "You can't upload files of this type. Only JPG, and PNG files are allowed.",
        dictRemoveFile: "Remove file",
        previewTemplate: customPreviewTemplate, // Use the modern template

        init: function() {
            const dropzone = this;

            // Only allow one file at a time, replace if new one is added
            this.on("addedfile", function(file) {
                if (this.files.length > 1) {
                    this.removeFile(this.files[0]);
                }
                uploadedFile = file;
                generateBtn.disabled = false;
                generateBtn.style.opacity = '1';
                console.log("File added:", file.name);
            });

            // Handle file removal
            this.on("removedfile", function(file) {
                uploadedFile = null;
                generateBtn.disabled = true;
                generateBtn.style.opacity = '0.6';
                hideProcessingStatus();
            });

            // Handle processing when manually triggered
            this.on("sending", function(file, xhr, formData) {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                formData.append('csrfmiddlewaretoken', csrfToken);

                // Add quiz configuration
                const config = getQuizConfig();
                Object.keys(config).forEach(key => {
                    if (config[key]) {
                        formData.append(key, config[key]);
                    }
                });

                // Show processing status
                showProcessingStatus();
            });

            // Handle successful upload
            this.on("success", function(file, response) {
                console.log("Dropzone success response:", response);
                if (response.success) {
                    // Show success message
                    showSuccessMessage(`Document processed successfully! Generated ${response.questions_generated} questions.`);

                    // Reload the current page after a short delay to show updated quiz list
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showErrorMessage(response.error || 'Processing failed');
                    resetGenerateButton();
                }
            });

            // Handle upload errors
            this.on("error", function(file, errorMessage, xhr) {
                console.error("Dropzone error:", errorMessage, xhr);
                showErrorMessage(typeof errorMessage === 'string' ? errorMessage : 'Processing failed');
                resetGenerateButton();
            });
        }
    });

    // Generate button click handler
    generateBtn.addEventListener('click', function() {
        if (!uploadedFile) {
            alert('Please upload a document first');
            return;
        }

        // Show loading state
        btnText.style.display = 'none';
        loadingSpinner.style.display = 'inline-block';
        generateBtn.disabled = true;
        showProcessingStatus(); // Ensure processing status is shown immediately

        // Set the correct URL and process the file
        myDropzone.options.url = "{% url 'dashboard:api_process_document' %}";
        myDropzone.processQueue();
    });

    // Modern Processing Animation Functions
    let currentStage = 0;
    let progressInterval;
    let currentProgress = 0;

    function showProcessingStatus() {
        processingStatus.style.display = 'block';
        currentStage = 0;
        currentProgress = 0;

        // Reset all stages
        document.querySelectorAll('.stage').forEach(stage => {
            stage.classList.remove('active', 'completed');
        });

        // Start the processing animation
        startProcessingAnimation();

        // Simulate real-time progress with enhanced timing
        enhancedSimulateProgress();
    }

    function hideProcessingStatus() {
        processingStatus.style.display = 'none';
        if (progressInterval) {
            clearInterval(progressInterval);
        }
        currentProgress = 0;
        updateProgressRing(0);
    }

    function startProcessingAnimation() {
        // Add entrance animation
        const container = document.querySelector('.processing-container');
        container.style.opacity = '0';
        container.style.transform = 'scale(0.9)';

        setTimeout(() => {
            container.style.transition = 'all 0.5s ease';
            container.style.opacity = '1';
            container.style.transform = 'scale(1)';
        }, 100);

        // Start particles animation
        createProcessingParticles();
    }

    function simulateProgress() {
        const stages = [
            { name: 'upload', title: 'Uploading Document', message: 'Securely uploading your file...', progress: 25, time: '30 seconds' },
            { name: 'analyze', title: 'Analyzing Content', message: 'AI is reading and understanding your document...', progress: 50, time: '45 seconds' },
            { name: 'generate', title: 'Generating Questions', message: 'Creating intelligent questions from your content...', progress: 85, time: '15 seconds' },
            { name: 'complete', title: 'Almost Done', message: 'Finalizing your quiz...', progress: 100, time: 'Complete!' }
        ];

        let stageIndex = 0;

        function nextStage() {
            if (stageIndex < stages.length) {
                const stage = stages[stageIndex];
                updateProcessingStage(stage);
                stageIndex++;

                // Move to next stage after delay
                setTimeout(nextStage, 2000 + Math.random() * 3000); // 2-5 seconds per stage
            }
        }

        nextStage();
    }

    function updateProcessingStage(stage) {
        // Update stage indicators
        const stageElement = document.getElementById(`stage-${stage.name}`);
        if (stageElement) {
            // Mark previous stages as completed
            document.querySelectorAll('.stage').forEach((el, index) => {
                if (index < currentStage) {
                    el.classList.add('completed');
                    el.classList.remove('active');
                }
            });

            // Mark current stage as active
            stageElement.classList.add('active');
            currentStage++;
        }

        // Update text content
        document.getElementById('status-title').textContent = stage.title;
        document.getElementById('status-message').textContent = stage.message;
        document.getElementById('estimated-time').textContent = stage.time;

        // Update progress ring
        animateProgressTo(stage.progress);

        // Update icon based on stage
        const iconElement = document.getElementById('progress-icon').querySelector('i');
        const iconMap = {
            'upload': 'ri-upload-cloud-line',
            'analyze': 'ri-search-eye-line',
            'generate': 'ri-magic-line',
            'complete': 'ri-check-line'
        };
        iconElement.className = iconMap[stage.name] || 'ri-file-text-line';
    }

    function animateProgressTo(targetProgress) {
        const progressCircle = document.getElementById('progress-circle');
        const progressPercentage = document.getElementById('progress-percentage');
        const circumference = 2 * Math.PI * 50; // radius = 50

        const animateStep = () => {
            if (currentProgress < targetProgress) {
                currentProgress += 1;
                updateProgressRing(currentProgress);
                requestAnimationFrame(animateStep);
            }
        };

        animateStep();
    }

    function updateProgressRing(progress) {
        const progressCircle = document.getElementById('progress-circle');
        const progressPercentage = document.getElementById('progress-percentage');
        const circumference = 2 * Math.PI * 50;

        const offset = circumference - (progress / 100) * circumference;
        progressCircle.style.strokeDashoffset = offset;
        progressPercentage.textContent = `${Math.round(progress)}%`;
    }

    function createProcessingParticles() {
        const particlesContainer = document.querySelector('.processing-particles');
        particlesContainer.innerHTML = '';

        for (let i = 0; i < 20; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = Math.random() * 100 + '%';
            particle.style.animationDelay = Math.random() * 3 + 's';
            particle.style.animationDuration = (3 + Math.random() * 2) + 's';
            particlesContainer.appendChild(particle);
        }
    }

    function showSuccessMessage(message) {
        // Complete all stages
        document.querySelectorAll('.stage').forEach(stage => {
            stage.classList.add('completed');
            stage.classList.remove('active');
        });

        // Update to success state
        document.getElementById('status-title').textContent = 'Success!';
        document.getElementById('status-message').textContent = message;
        document.getElementById('estimated-time').textContent = 'Complete!';

        // Final progress animation
        animateProgressTo(100);

        // Success icon
        const iconElement = document.getElementById('progress-icon').querySelector('i');
        iconElement.className = 'ri-check-line';

        // Add success glow effect
        const progressRing = document.querySelector('.progress-ring-container');
        progressRing.classList.add('success');

        // Add celebration particles
        createCelebrationParticles();
    }

    function createCelebrationParticles() {
        const container = document.querySelector('.processing-container');

        for (let i = 0; i < 30; i++) {
            const particle = document.createElement('div');
            particle.style.position = 'absolute';
            particle.style.width = '6px';
            particle.style.height = '6px';
            particle.style.background = `hsl(${Math.random() * 60 + 280}, 70%, 60%)`;
            particle.style.borderRadius = '50%';
            particle.style.left = '50%';
            particle.style.top = '50%';
            particle.style.pointerEvents = 'none';
            particle.style.zIndex = '1000';

            const angle = (Math.PI * 2 * i) / 30;
            const velocity = 100 + Math.random() * 100;
            const lifetime = 1000 + Math.random() * 1000;

            container.appendChild(particle);

            let startTime = Date.now();
            function animateParticle() {
                const elapsed = Date.now() - startTime;
                const progress = elapsed / lifetime;

                if (progress < 1) {
                    const x = Math.cos(angle) * velocity * progress;
                    const y = Math.sin(angle) * velocity * progress - (progress * progress * 200);
                    const opacity = 1 - progress;

                    particle.style.transform = `translate(${x}px, ${y}px)`;
                    particle.style.opacity = opacity;

                    requestAnimationFrame(animateParticle);
                } else {
                    container.removeChild(particle);
                }
            }

            requestAnimationFrame(animateParticle);
        }
    }

    // Enhanced progress tracking with more realistic timing
    function enhancedSimulateProgress() {
        const stages = [
            {
                name: 'upload',
                title: 'Uploading Document',
                message: 'Securely uploading your file...',
                progress: 15,
                time: '20-30 seconds',
                duration: 3000
            },
            {
                name: 'analyze',
                title: 'Analyzing Content',
                message: 'AI is reading and understanding your document...',
                progress: 45,
                time: '30-60 seconds',
                duration: 5000
            },
            {
                name: 'generate',
                title: 'Generating Questions',
                message: 'Creating intelligent questions from your content...',
                progress: 85,
                time: '10-20 seconds',
                duration: 4000
            },
            {
                name: 'complete',
                title: 'Finalizing',
                message: 'Adding finishing touches to your quiz...',
                progress: 98,
                time: 'Almost done!',
                duration: 2000
            }
        ];

        let stageIndex = 0;

        function nextStage() {
            if (stageIndex < stages.length) {
                const stage = stages[stageIndex];
                updateProcessingStage(stage);
                stageIndex++;

                // Use stage-specific duration
                setTimeout(nextStage, stage.duration);
            }
        }

        nextStage();
    }

    function showErrorMessage(message) {
        alert('Error: ' + message);
        hideProcessingStatus();
    }

    function resetGenerateButton() {
        btnText.style.display = 'inline';
        loadingSpinner.style.display = 'none';
        generateBtn.disabled = uploadedFile ? false : true;
        hideProcessingStatus();
    }

    // Auto-refresh recent jobs if there are processing ones
    const processingJobs = document.querySelectorAll('.status-processing, .status-pending');
    if (processingJobs.length > 0) {
        setTimeout(() => {
            location.reload();
        }, 10000); // Refresh every 10 seconds
    }
});

// Demo function for testing the animation
function demoProcessingAnimation() {
    const processingStatus = document.getElementById('processing-status');
    processingStatus.style.display = 'block';

    // Reset and start animation
    document.querySelectorAll('.stage').forEach(stage => {
        stage.classList.remove('active', 'completed');
    });

    // Initialize progress ring
    const progressCircle = document.getElementById('progress-circle');
    if (progressCircle) {
        const circumference = 2 * Math.PI * 50;
        progressCircle.style.strokeDasharray = circumference;
        progressCircle.style.strokeDashoffset = circumference;
    }

    // Start demo animation
    const container = document.querySelector('.processing-container');
    container.style.opacity = '0';
    container.style.transform = 'scale(0.9)';

    setTimeout(() => {
        container.style.transition = 'all 0.5s ease';
        container.style.opacity = '1';
        container.style.transform = 'scale(1)';
    }, 100);

    // Create particles
    const particlesContainer = document.querySelector('.processing-particles');
    particlesContainer.innerHTML = '';

    for (let i = 0; i < 20; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 3 + 's';
        particle.style.animationDuration = (3 + Math.random() * 2) + 's';
        particlesContainer.appendChild(particle);
    }

    // Run demo stages
    const stages = [
        { name: 'upload', title: 'Demo: Uploading', message: 'Simulating file upload...', progress: 25, time: '5 seconds' },
        { name: 'analyze', title: 'Demo: Analyzing', message: 'Simulating content analysis...', progress: 50, time: '3 seconds' },
        { name: 'generate', title: 'Demo: Generating', message: 'Simulating question generation...', progress: 85, time: '2 seconds' },
        { name: 'complete', title: 'Demo Complete!', message: 'Animation demo finished successfully!', progress: 100, time: 'Done!' }
    ];

    let stageIndex = 0;
    let currentProgress = 0;

    function nextDemoStage() {
        if (stageIndex < stages.length) {
            const stage = stages[stageIndex];

            // Update stage indicators
            const stageElement = document.getElementById(`stage-${stage.name}`);
            if (stageElement) {
                document.querySelectorAll('.stage').forEach((el, index) => {
                    if (index < stageIndex) {
                        el.classList.add('completed');
                        el.classList.remove('active');
                    }
                });
                stageElement.classList.add('active');
            }

            // Update text content
            document.getElementById('status-title').textContent = stage.title;
            document.getElementById('status-message').textContent = stage.message;
            document.getElementById('estimated-time').textContent = stage.time;

            // Animate progress
            const targetProgress = stage.progress;
            const animateStep = () => {
                if (currentProgress < targetProgress) {
                    currentProgress += 2;
                    const progressCircle = document.getElementById('progress-circle');
                    const progressPercentage = document.getElementById('progress-percentage');
                    const circumference = 2 * Math.PI * 50;

                    const offset = circumference - (currentProgress / 100) * circumference;
                    progressCircle.style.strokeDashoffset = offset;
                    progressPercentage.textContent = `${Math.round(currentProgress)}%`;

                    requestAnimationFrame(animateStep);
                }
            };
            animateStep();

            stageIndex++;

            if (stageIndex < stages.length) {
                setTimeout(nextDemoStage, 2000);
            } else {
                // Demo complete - add celebration
                setTimeout(() => {
                    const progressRing = document.querySelector('.progress-ring-container');
                    progressRing.classList.add('success');

                    // Add celebration particles
                    const container = document.querySelector('.processing-container');
                    for (let i = 0; i < 30; i++) {
                        const particle = document.createElement('div');
                        particle.style.position = 'absolute';
                        particle.style.width = '6px';
                        particle.style.height = '6px';
                        particle.style.background = `hsl(${Math.random() * 60 + 280}, 70%, 60%)`;
                        particle.style.borderRadius = '50%';
                        particle.style.left = '50%';
                        particle.style.top = '50%';
                        particle.style.pointerEvents = 'none';
                        particle.style.zIndex = '1000';

                        const angle = (Math.PI * 2 * i) / 30;
                        const velocity = 100 + Math.random() * 100;
                        const lifetime = 1000 + Math.random() * 1000;

                        container.appendChild(particle);

                        let startTime = Date.now();
                        function animateParticle() {
                            const elapsed = Date.now() - startTime;
                            const progress = elapsed / lifetime;

                            if (progress < 1) {
                                const x = Math.cos(angle) * velocity * progress;
                                const y = Math.sin(angle) * velocity * progress - (progress * progress * 200);
                                const opacity = 1 - progress;

                                particle.style.transform = `translate(${x}px, ${y}px)`;
                                particle.style.opacity = opacity;

                                requestAnimationFrame(animateParticle);
                            } else {
                                container.removeChild(particle);
                            }
                        }

                        requestAnimationFrame(animateParticle);
                    }

                    // Auto-hide after 3 seconds
                    setTimeout(() => {
                        processingStatus.style.display = 'none';
                        progressRing.classList.remove('success');
                    }, 3000);
                }, 1000);
            }
        }
    }

    nextDemoStage();
}

// Global function for canceling processing
function cancelProcessing() {
    if (confirm('Are you sure you want to cancel the processing? This will stop the current operation.')) {
        // Hide processing status
        const processingStatus = document.getElementById('processing-status');
        processingStatus.style.display = 'none';

        // Reset generate button
        const generateBtn = document.getElementById('generate-btn');
        const btnText = document.getElementById('btn-text');
        const loadingSpinner = document.getElementById('loading-spinner');

        btnText.style.display = 'inline';
        loadingSpinner.style.display = 'none';
        generateBtn.disabled = false;

        // Show notification
        showNotification('Processing cancelled', 'info');

        // Clear any ongoing intervals
        if (window.progressInterval) {
            clearInterval(window.progressInterval);
        }
    }
}

// Global function for deleting quizzes
function deleteQuiz(jobId, documentName) {
    if (confirm(`Are you sure you want to delete "${documentName}"? This action cannot be undone.`)) {
        // Show loading state
        const deleteBtn = event.target.closest('button');
        const originalContent = deleteBtn.innerHTML;
        deleteBtn.innerHTML = '<i class="ri-loader-4-line"></i>';
        deleteBtn.disabled = true;

        // Send delete request
        fetch(`/api/brain/jobs/${jobId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (response.ok) {
                // Remove the job item from the DOM
                const jobItem = deleteBtn.closest('.job-item');
                jobItem.style.transition = 'opacity 0.3s ease';
                jobItem.style.opacity = '0';
                setTimeout(() => {
                    jobItem.remove();

                    // Check if no jobs left
                    const jobsList = document.querySelector('.jobs-list');
                    if (jobsList && jobsList.children.length === 0) {
                        const recentJobs = document.querySelector('.recent-jobs');
                        if (recentJobs) {
                            recentJobs.style.display = 'none';
                        }
                    }
                }, 300);

                // Show success message
                showNotification('Quiz deleted successfully', 'success');
            } else {
                throw new Error('Failed to delete quiz');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Restore button state
            deleteBtn.innerHTML = originalContent;
            deleteBtn.disabled = false;
            showNotification('Failed to delete quiz. Please try again.', 'error');
        });
    }
}

// Function to show notifications
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <i class="ri-${type === 'success' ? 'check' : 'error-warning'}-line"></i>
            <span>${message}</span>
        </div>
    `;

    // Add to page
    document.body.appendChild(notification);

    // Show with animation
    setTimeout(() => {
        notification.classList.add('show');
    }, 100);

    // Remove after 3 seconds
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}
</script>

<style>
/* Quiz Configuration Styles */
.quiz-options-form {
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.quiz-options-form h3 {
    margin-top: 0;
    margin-bottom: 15px;
    color: #ffffff;
}

.upload-section {
    margin-bottom: 20px;
}

.upload-section h3 {
    margin-bottom: 10px;
    color: #ffffff;
}

.upload-description {
    color: #666;
    font-size: 0.9em;
    margin-bottom: 15px;
}

/* Dropzone Customization */
.dropzone {
    border: 2px dashed #007bff;
    border-radius: 10px;
    padding: 40px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.dropzone:hover {
    border-color: #0056b3;
}

.dropzone .dz-message {
    margin: 0;
}

.dropzone .upload-icon {
    font-size: 3em;
    color: #007bff;
    margin-bottom: 15px;
}

.dropzone .dz-message h4 {
    margin: 10px 0;
    color: #ffffff;
    font-size: 1.2em;
}

.dropzone .dz-message p {
    margin: 0;
    color: #666;
    font-size: 0.9em;
}

/* Dropzone file preview */
.dropzone .dz-preview {
    margin: 10px;
    border-radius: 8px;
    padding: 15px;
    border: 1px solid #ddd;
}

.dropzone .dz-preview .dz-filename {
    font-weight: 500;
}

.dropzone .dz-preview .dz-size {
    color: #666;
    font-size: 0.9em;
}

.dropzone .dz-preview .dz-progress {
    height: 4px;
    background: #e9ecef;
    border-radius: 2px;
    overflow: hidden;
    margin: 10px 0;
}

.dropzone .dz-preview .dz-progress .dz-upload {
    background: #007bff;
    height: 100%;
    transition: width 0.3s ease;
}

.dropzone .dz-preview .dz-remove {
    color: #dc3545;
    text-decoration: none;
    font-size: 0.9em;
}

.dropzone .dz-preview .dz-remove:hover {
    text-decoration: underline;
}

/* Modern Processing Animation Styles */
.modern-processing-status {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(10, 10, 25, 0.95);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.5s ease;
}

.processing-container {
    position: relative;
    background: rgba(15, 15, 35, 0.9);
    border: 1px solid rgba(94, 23, 235, 0.3);
    border-radius: 24px;
    padding: 40px;
    max-width: 500px;
    width: 90%;
    text-align: center;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    overflow: hidden;
}

.processing-bg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    overflow: hidden;
    border-radius: 24px;
}

.processing-particles {
    position: absolute;
    width: 100%;
    height: 100%;
}

.particle {
    position: absolute;
    width: 4px;
    height: 4px;
    background: linear-gradient(45deg, #5e17eb, #00d4ff);
    border-radius: 50%;
    animation: floatUp 4s infinite linear;
    opacity: 0;
}

@keyframes floatUp {
    0% {
        transform: translateY(100vh) scale(0);
        opacity: 0;
    }
    10% {
        opacity: 1;
    }
    90% {
        opacity: 1;
    }
    100% {
        transform: translateY(-100px) scale(1);
        opacity: 0;
    }
}

.processing-waves {
    position: absolute;
    width: 100%;
    height: 100%;
}

.wave {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 200px;
    height: 200px;
    border: 2px solid rgba(94, 23, 235, 0.3);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    animation: pulse 2s infinite ease-in-out;
}

.wave-2 {
    animation-delay: 0.5s;
    border-color: rgba(0, 212, 255, 0.3);
}

.wave-3 {
    animation-delay: 1s;
    border-color: rgba(255, 149, 0, 0.3);
}

@keyframes pulse {
    0% {
        transform: translate(-50%, -50%) scale(0.5);
        opacity: 1;
    }
    100% {
        transform: translate(-50%, -50%) scale(2);
        opacity: 0;
    }
}

.processing-content {
    position: relative;
    z-index: 10;
}

.progress-ring-container {
    position: relative;
    margin: 0 auto 30px;
    width: 120px;
    height: 120px;
}

.progress-ring {
    transform: rotate(-90deg);
    width: 120px;
    height: 120px;
}

.progress-ring-bg {
    fill: none;
    stroke: rgba(255, 255, 255, 0.1);
    stroke-width: 8;
}

.progress-ring-fill {
    fill: none;
    stroke: url(#progressGradient);
    stroke-width: 8;
    stroke-linecap: round;
    stroke-dasharray: 314.16; /* 2 * PI * 50 */
    stroke-dashoffset: 314.16;
    transition: stroke-dashoffset 0.5s ease;
}

.progress-center {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.progress-icon {
    font-size: 2rem;
    color: #5e17eb;
    margin-bottom: 5px;
    animation: iconPulse 2s infinite ease-in-out;
}

.progress-percentage {
    font-size: 0.9rem;
    font-weight: 600;
    color: #ffffff;
}

@keyframes iconPulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.1);
    }
}

.status-info h3 {
    font-size: 1.5rem;
    font-weight: 600;
    color: #ffffff;
    margin-bottom: 10px;
    background: linear-gradient(90deg, #5e17eb, #00d4ff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.status-info p {
    color: #aaaaaa;
    margin-bottom: 25px;
    font-size: 1rem;
}

.status-stages {
    display: flex;
    justify-content: space-between;
    margin: 25px 0;
    padding: 0 10px;
}

.stage {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    opacity: 0.4;
    transition: all 0.3s ease;
}

.stage.active {
    opacity: 1;
    transform: scale(1.1);
}

.stage.completed {
    opacity: 1;
}

.stage.completed .stage-icon {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
}

.stage-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    color: #ffffff;
    transition: all 0.3s ease;
}

.stage.active .stage-icon {
    background: linear-gradient(135deg, #5e17eb, #7c3aed);
    animation: stagePulse 1.5s infinite ease-in-out;
}

@keyframes stagePulse {
    0%, 100% {
        box-shadow: 0 0 0 0 rgba(94, 23, 235, 0.7);
    }
    50% {
        box-shadow: 0 0 0 10px rgba(94, 23, 235, 0);
    }
}

.stage span {
    font-size: 0.8rem;
    color: #ffffff;
    font-weight: 500;
}

.estimated-time {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    color: #aaaaaa;
    font-size: 0.9rem;
    margin-top: 20px;
}

.estimated-time i {
    color: #5e17eb;
}

.cancel-processing-btn {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #ef4444;
    border-radius: 8px;
    padding: 10px 20px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.cancel-processing-btn:hover {
    background: rgba(239, 68, 68, 0.2);
    border-color: rgba(239, 68, 68, 0.5);
    transform: translateY(-1px);
}

.progress-ring-container.success {
    animation: successPulse 0.6s ease;
}

@keyframes successPulse {
    0% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.1);
    }
    100% {
        transform: scale(1);
    }
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

/* Responsive Styles for Processing Animation */
@media screen and (max-width: 768px) {
    .processing-container {
        padding: 30px 20px;
        margin: 20px;
        max-width: none;
        width: calc(100% - 40px);
    }

    .progress-ring-container {
        width: 100px;
        height: 100px;
        margin-bottom: 20px;
    }

    .progress-ring {
        width: 100px;
        height: 100px;
    }

    .progress-icon {
        font-size: 1.5rem;
    }

    .status-info h3 {
        font-size: 1.3rem;
    }

    .status-stages {
        padding: 0 5px;
        gap: 5px;
    }

    .stage-icon {
        width: 35px;
        height: 35px;
        font-size: 1rem;
    }

    .stage span {
        font-size: 0.7rem;
    }

    .wave {
        width: 150px;
        height: 150px;
    }
}

.recent-jobs {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #eee;
}

.jobs-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin: 15px 0;
}

.job-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #007bff;
    min-width: 0;
}

.job-info {
    flex: 1 1 0;
    min-width: 0;
}

.job-filename {
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    display: block;
}

.job-status {
    font-size: 0.9em;
    font-weight: 500;
    margin: 5px 0;
}

.status-completed { color: #28a745; }
.status-processing { color: #007bff; }
.status-pending { color: #ffc107; }
.status-failed { color: #dc3545; }

.btn-small {
    padding: 8px 12px;
    font-size: 0.9em;
    text-decoration: none;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    margin-right: 5px;
}

.btn-small.btn-primary {
    background-color: #007bff;
    color: white;
}

.btn-small.btn-primary:hover {
    background-color: #0056b3;
    color: white;
    text-decoration: none;
}

.btn-small.btn-secondary {
    background-color: #6c757d;
    color: white;
}

.btn-small.btn-secondary:hover {
    background-color: #5a6268;
    color: white;
    text-decoration: none;
}

.btn-small.btn-danger {
    background-color: #dc3545;
    color: white;
    padding: 8px 10px;
}

.btn-small.btn-danger:hover {
    background-color: #c82333;
    transform: scale(1.05);
}

.btn-small:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.error-text { color: #dc3545; }
.processing-text { color: #007bff; }

.view-all-link {
    color: #007bff;
    text-decoration: none;
    font-weight: 500;
}

.view-all-link:hover {
    text-decoration: underline;
}

#loading-spinner i {
    animation: spin 1s linear infinite;
}

/* Generate Button Styles */
.generate-btn {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 8px;
    font-size: 1.1em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 20px;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.generate-btn:hover:not(:disabled) {
    background: linear-gradient(135deg, #0056b3, #004085);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
}

.generate-btn:disabled {
    background: #6c757d;
    cursor: not-allowed;
    opacity: 0.6;
    transform: none;
    box-shadow: none;
}

.generate-btn i {
    font-size: 1.2em;
}

#loading-spinner {
    display: none;
}

/* Notification Styles */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    background: rgba(255, 255, 255, 0.1);
    padding: 15px 20px;
    z-index: 1000;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    border-left: 4px solid #007bff;
}

.notification.show {
    transform: translateX(0);
}

.notification.notification-success {
    border-left-color: #28a745;
}

.notification.notification-error {
    border-left-color: #dc3545;
}

.notification-content {
    display: flex;
    align-items: center;
    gap: 10px;
}

.notification-content i {
    font-size: 1.2em;
}

.notification-success .notification-content i {
    color: #28a745;
}

.notification-error .notification-content i {
    color: #dc3545;
}

/* Job Actions Layout */
.job-actions {
    display: flex;
    align-items: center;
    gap: 5px;
    flex-wrap: wrap;
}

/* Modern Dropzone Preview */
.modern-preview {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #181c24;
    border-radius: 8px;
    padding: 18px 24px;
    margin-top: 18px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border: 1px solid #23283a;
    color: #fff;
}
.modern-preview .dz-details {
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.modern-preview .dz-filename {
    font-weight: 600;
    font-size: 1.1em;
}
.modern-preview .dz-size {
    font-size: 0.95em;
    color: #aaa;
}
.modern-preview .dz-remove-btn {
    display: flex;
    align-items: center;
}
.modern-preview .dz-remove {
    color: #ff4d4f;
    background: none;
    border: none;
    font-weight: 500;
    font-size: 1em;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    text-decoration: none;
    transition: color 0.2s;
}
.modern-preview .dz-remove:hover {
    color: #ff7875;
    text-decoration: underline;
}
</style>

{% endblock %}